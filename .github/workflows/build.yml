name: build-publish

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}/nginx-naxsi
  NGINX_VERSION: "1.29.2"   # bump here in PRs
  NAXSI_VERSION: "1.7"      # bump here in PRs
  TEST_PORT: "8080"

permissions:
  contents: read
  id-token: write      # for keyless signing
  packages: write
  security-events: write

jobs:
  # Build once for amd64 and RUN IT with mounted fixtures (dynamic mounts)
  smoke:
    name: Smoke test (mounted config/rules)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build (amd64, --load) for local run
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: false
          load: true
          build-args: |
            NGINX_VERSION=${{ env.NGINX_VERSION }}
            NAXSI_VERSION=${{ env.NAXSI_VERSION }}
          tags: nginx-naxsi:test-local
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Prepare test fixtures (mounted at runtime)
        run: |
          set -euo pipefail
          mkdir -p test/fixtures/conf test/fixtures/naxsi
          cat > test/fixtures/conf/nginx.conf <<'NGINX'
          load_module modules/ngx_http_naxsi_module.so;

          user  nginx;
          worker_processes auto;

          events { worker_connections 1024; }

          http {
            include       mime.types;
            default_type  application/octet-stream;
            sendfile      on;

            include /etc/nginx/naxsi/naxsi_core.rules;
            include /etc/nginx/naxsi/app.rules;

            server {
              listen 80 default_server;

              location / {
                SecRulesEnabled;
                LearningMode;
                DeniedUrl "/RequestDenied";
                return 200 "ok\n";
              }

              location = /RequestDenied { return 403; }
              location /healthz { return 200 "ok\n"; add_header Content-Type text/plain; }
            }
          }
          NGINX

          # Pin rules to a release (dynamic mount, but deterministic in CI)
          curl -fsSL https://raw.githubusercontent.com/wargio/naxsi/${{ env.NAXSI_VERSION }}/naxsi_rules/naxsi_core.rules \
            -o test/fixtures/naxsi/naxsi_core.rules

          # Minimal per-app overrides with CheckRules
          cat > test/fixtures/naxsi/app.rules <<'APPRULES'
          # CheckRules required for blocking
          CheckRule "$SQL >= 8" BLOCK;
          CheckRule "$RFI >= 8" BLOCK;
          CheckRule "$TRAVERSAL >= 4" BLOCK;
          CheckRule "$XSS >= 8" BLOCK;
          CheckRule "$EVADE >= 4" BLOCK;
          CheckRule "$UPLOAD >= 8" BLOCK;
          APPRULES

      - name: Run container with mounted fixtures
        run: |
          set -euo pipefail
          docker run -d --name nginx-naxsi-ci \
            -p $TEST_PORT:80 \
            -v "$GITHUB_WORKSPACE/test/fixtures/conf/nginx.conf:/etc/nginx/nginx.conf:ro" \
            -v "$GITHUB_WORKSPACE/test/fixtures/naxsi:/etc/nginx/naxsi:ro" \
            nginx-naxsi:test-local
          # basic health
          for i in {1..30}; do
            curl -fsS "http://127.0.0.1:${TEST_PORT}/healthz" && break || sleep 1
          done
          # prove naxsi is active (LearningMode will not block; just ensure 200 from root)
          curl -fsS "http://127.0.0.1:${TEST_PORT}/" | grep -qi "ok"
          docker logs nginx-naxsi-ci | tail -n +1 || true

      - name: Stop container
        if: always()
        run: docker rm -f nginx-naxsi-ci || true

  # Build multi-arch and push
  build:
    name: Build & Push (multi-arch)
    runs-on: ubuntu-latest
    needs: smoke
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=mainline-${{ env.NGINX_VERSION }}
            type=raw,value=naxsi-${{ env.NAXSI_VERSION }}
            type=ref,event=tag
            type=raw,value=sha-${{ github.sha }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      - name: Build & Push
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NGINX_VERSION=${{ env.NGINX_VERSION }}
            NAXSI_VERSION=${{ env.NAXSI_VERSION }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: true
          sbom: true

  sign:
    name: Cosign sign (keyless)
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.6.0
      - name: Keyless sign
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes $IMAGE_NAME:mainline-${{ env.NGINX_VERSION }}
          cosign attest --yes --predicate <(echo '{"build":"github-actions"}') --type slsaprovenance $IMAGE_NAME:mainline-${{ env.NGINX_VERSION }}
